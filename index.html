
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnStep Konfigurátor</title>
    <meta name="description" content="Vizuális konfigurátor OnStep csillagászati távcsővezérlőhöz.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0c0f1a;
            --container-bg: rgba(26, 29, 46, 0.95);
            --primary-accent: #00aaff;
            --secondary-accent: #ffaa00;
            --text-color: #e0e5f0;
            --text-muted: #8a99b5;
            --border-color: #343a5e;
            --input-bg: #10121e;
            --shadow-color: rgba(0, 170, 255, 0.2);
            --success-color: #28a745;
            --error-color: #dc3545;
            --border-radius: 12px;
            --font-main: 'Roboto', sans-serif;
            --font-title: 'Orbitron', sans-serif;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 2rem 1rem;
            position: relative;
            overflow: hidden;
        }

        #constellation-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        .hidden { display: none !important; }

        main {
            position: relative; z-index: 10; max-width: 900px; width: 100%;
            padding: 2.5rem; background-color: var(--container-bg); border-radius: var(--border-radius);
            border: 1px solid var(--border-color); box-shadow: 0 8px 32px 0 var(--shadow-color);
            text-align: center; transition: all 0.3s ease; flex-grow: 1; display: flex; flex-direction: column;
        }
        
        .app-header { position: absolute; top: 1rem; right: 1rem; display: flex; align-items: center; z-index: 20; }
        #language-selector { background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-muted); border-radius: 6px; padding: 0.25rem 0.5rem; font-size: 0.8rem; }

        h1, h2, h3 { font-family: var(--font-title); color: var(--primary-accent); letter-spacing: 1.5px; text-shadow: 0 0 5px var(--shadow-color); }
        h1 { font-size: 2.5rem; margin: 0 0 1rem 0; }
        h2 { font-size: 1.8rem; margin-bottom: 2rem; text-align: center; }
        h3 { font-size: 1.5rem; margin-bottom: 1rem; }
        p { color: var(--text-muted); font-size: 1.1rem; max-width: 600px; margin: 0 auto 2.5rem auto; }
        
        .main-content { flex-grow: 1; display: flex; flex-direction: column; }
        .version-selector-container { display: flex; gap: 2rem; justify-content: center; align-items: stretch; margin-bottom: 2rem; }
        .version-card { background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 2rem; flex: 1; max-width: 320px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; text-align: center; }
        .version-card:hover { transform: translateY(-5px); border-color: var(--primary-accent); box-shadow: 0 10px 30px 0 var(--shadow-color); }
        .version-card h3 { margin: 0 0 0.5rem 0; }
        .version-card p { font-size: 0.9rem; margin-bottom: 0; color: var(--text-muted); text-align: center; max-width: 100%; }

        .comparison-section { display: flex; gap: 2rem; text-align: left; margin-bottom: 2rem; background-color: var(--input-bg); padding: 1.5rem; border-radius: var(--border-radius); }
        .comparison-column { flex: 1; }
        .comparison-column ul { padding-left: 1.2rem; margin: 0; font-size: 0.9rem; color: var(--text-muted); }
        .comparison-column li { margin-bottom: 0.5rem; }

        .button { background: none; border: 1px solid var(--border-color); color: var(--text-muted); padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s ease; font-family: var(--font-title); }
        .button:hover { color: var(--text-color); border-color: var(--primary-accent); background-color: var(--shadow-color); }
        .button.primary { border-color: var(--primary-accent); color: var(--primary-accent); }
        .button:disabled { opacity: 0.5; cursor: not-allowed; border-color: var(--border-color); color: var(--text-muted); background: none; }
        
        /* --- Wizard Styles --- */
        #config-wizard { text-align: left; display: flex; flex-direction: column; flex-grow: 1; }
        .wizard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: relative; flex-shrink: 0; }
        .back-button { background: none; border: 1px solid var(--border-color); color: var(--text-muted); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; }
        .back-button:hover { color: var(--text-color); border-color: var(--primary-accent); }
        .wizard-header h2 { position: absolute; left: 50%; transform: translateX(-50%); margin: 0; }
        .form-group { margin-bottom: 1.5rem; display: flex; flex-direction: column; }
        .form-group-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .form-group label { font-size: 1rem; font-weight: bold; color: var(--text-color); margin-bottom: 0.5rem; display: flex; align-items: center; }
        .info-icon { display: inline-block; width: 18px; height: 18px; border-radius: 50%; background-color: var(--border-color); color: var(--text-color); text-align: center; font-size: 12px; line-height: 18px; margin-left: 8px; cursor: pointer; transition: background-color 0.2s; }
        .info-icon:hover { background-color: var(--primary-accent); }
        .form-group select, .form-group input[type="text"], .form-group input[type="number"] { width: 100%; padding: 0.75rem 1rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-group select:focus, .form-group input:focus { outline: none; border-color: var(--primary-accent); box-shadow: 0 0 0 3px var(--shadow-color); }
        .form-group .radio-group { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .calculator-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; align-items: center; background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; margin-top: 0.5rem; }
        .calculator-grid label { font-size: 0.9rem; font-weight: normal; cursor: pointer; }
        .calculator-grid .form-group { margin-bottom: 0; }
        .wizard-nav { margin-top: auto; padding-top: 1.5rem; display: flex; justify-content: space-between; flex-shrink: 0; border-top: 1px solid var(--border-color); }
        .step-container { flex-grow: 1; overflow-y: auto; padding: 1.5rem 1rem 1.5rem 0; margin-top: 1.5rem; border-top: 1px solid var(--border-color); }
        #config-preview { width: 100%; height: 100%; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-muted); font-family: 'Courier New', Courier, monospace; font-size: 0.8rem; padding: 1rem; resize: vertical; }
        .axis-section h3 { font-size: 1.2rem; color: var(--secondary-accent); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-top: 2rem; }
        .axis-section:first-child h3 { margin-top: 0; }
        .microstep-display { background: var(--input-bg); padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--border-color); font-style: italic; color: var(--text-muted); font-size: 0.9rem; }

        /* --- Wiki Section --- */
        #wiki-section { text-align: left; display: flex; flex-direction: column; flex-grow: 1; }
        #wiki-content { display: flex; gap: 2rem; margin-top: 1rem; flex-grow: 1; overflow: hidden; }
        #wiki-nav { flex: 0 0 200px; overflow-y: auto; }
        #wiki-nav ul { list-style: none; padding: 0; margin: 0; }
        #wiki-nav a { display: block; padding: 0.5rem 1rem; color: var(--text-muted); text-decoration: none; border-radius: 6px; transition: background-color 0.2s, color 0.2s; }
        #wiki-nav a:hover { background-color: var(--input-bg); color: var(--text-color); }
        #wiki-nav a.active { background-color: var(--primary-accent); color: var(--bg-color); font-weight: bold; }
        #wiki-article { flex-grow: 1; overflow-y: auto; padding-right: 1rem; }
        #wiki-article h2 { text-align: left; }
        #wiki-article p, #wiki-article ul, #wiki-article li { font-size: 1rem; color: var(--text-muted); max-width: 100%; }
        #wiki-article a { color: var(--primary-accent); }
        #wiki-article code { background-color: var(--input-bg); padding: 0.1rem 0.3rem; border-radius: 4px; font-family: 'Courier New', Courier, monospace; color: var(--secondary-accent); }

        /* --- Modal Styles --- */
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(12, 15, 26, 0.8); display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--container-bg); margin: auto; padding: 2rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); max-width: 700px; width: 90%; box-shadow: 0 8px 32px 0 var(--shadow-color); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-header h3 { margin: 0; }
        .modal-close { color: var(--text-muted); font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close:hover { color: var(--text-color); }
        .modal-body p { font-size: 1rem; text-align: left; margin-bottom: 0; max-width: 100%; color: var(--text-muted); }
        .modal-body code { background-color: var(--input-bg); padding: 0.1rem 0.3rem; border-radius: 4px; font-family: 'Courier New', Courier, monospace; color: var(--secondary-accent); }
        .modal-body strong { color: var(--text-color); }

        /* --- Footer --- */
        footer { width: 100%; max-width: 900px; padding: 1.5rem 2.5rem; margin-top: auto; text-align: center; font-size: 0.9rem; color: var(--text-muted); }
    </style>
</head>
<body>
    <canvas id="constellation-canvas"></canvas>
    
    <main>
        <header class="app-header">
             <select id="language-selector" aria-label="Nyelvválasztás">
                <option value="hu">Magyar</option>
                <option value="en">English</option>
                <option value="de">Deutsch</option>
                <option value="es">Español</option>
            </select>
        </header>

        <div class="main-content">
            <section id="version-selector">
                <h1 data-lang-key="appTitle">OnStep Konfigurátor</h1>
                <p data-lang-key="appDescription"></p>
                <div class="version-selector-container">
                    <article class="version-card" data-version="classic" role="button" tabindex="0">
                        <h3 data-lang-key="classicTitle"></h3>
                        <p data-lang-key="classicTagline"></p>
                    </article>
                    <article class="version-card" data-version="onstepx" role="button" tabindex="0">
                        <h3 data-lang-key="onstepxTitle"></h3>
                        <p data-lang-key="onstepxTagline"></p>
                    </article>
                </div>

                <div class="comparison-section">
                    <div class="comparison-column">
                        <h3 data-lang-key="classicTitle"></h3>
                        <ul data-lang-key="classicFeatures"></ul>
                    </div>
                    <div class="comparison-column">
                        <h3 data-lang-key="onstepxTitle"></h3>
                        <ul data-lang-key="onstepxFeatures"></ul>
                    </div>
                </div>

                <button id="wiki-button" class="button" data-lang-key="wikiButton"></button>
            </section>

            <section id="config-wizard" class="hidden">
                <!-- Varázsló tartalma ide generálódik -->
            </section>

            <section id="wiki-section" class="hidden">
                 <div class="wizard-header">
                    <button class="back-button" id="wiki-back-button" data-lang-key="backToHomeButton"></button>
                    <h2 data-lang-key="wikiTitle"></h2>
                 </div>
                 <div id="wiki-content">
                    <nav id="wiki-nav">
                        <ul>
                            <li><a href="#prerequisites" data-lang-key="wikiNavPrerequisites" class="wiki-nav-link"></a></li>
                            <li><a href="#hardware" data-lang-key="wikiNavHardware" class="wiki-nav-link"></a></li>
                            <li><a href="#gearing" data-lang-key="wikiNavGearing" class="wiki-nav-link"></a></li>
                        </ul>
                    </nav>
                    <article id="wiki-article"></article>
                </div>
            </section>
        </div>
    </main>

    <footer id="app-footer"></footer>

    <div id="info-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"></h3>
                <span class="modal-close" role="button" aria-label="Close">&times;</span>
            </div>
            <div class="modal-body">
                <p id="modal-text"></p>
            </div>
        </div>
    </div>
    
    <div id="belt-calc-modal" class="modal">
         <div class="modal-content">
            <div class="modal-header">
                <h3 data-lang-key="beltCalcTitle"></h3>
                <span class="modal-close" role="button" aria-label="Close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group-grid">
                    <div class="form-group">
                        <label for="belt-p1" data-lang-key="beltCalcP1"></label>
                        <input type="number" id="belt-p1" value="16">
                    </div>
                     <div class="form-group">
                        <label for="belt-p2" data-lang-key="beltCalcP2"></label>
                        <input type="number" id="belt-p2" value="48">
                    </div>
                     <div class="form-group">
                        <label for="belt-pitch" data-lang-key="beltCalcPitch"></label>
                        <input type="number" id="belt-pitch" value="2">
                    </div>
                    <div class="form-group">
                        <label for="belt-distance" data-lang-key="beltCalcDist"></label>
                        <input type="number" id="belt-distance" value="50">
                    </div>
                </div>
                <div id="belt-calc-results" style="margin-top: 1rem; background: var(--input-bg); padding: 1rem; border-radius: 8px;">
                    <h4 data-lang-key="beltCalcResult"></h4>
                    <p id="belt-result-text"></p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // ===================================================================================
        // CONSTANTS & CONFIGURATION
        // ===================================================================================
        const APP_VERSION = "0.0.4.0-beta";

        const calculatorOptions = {
            motorSteps: [200, 400],
            microsteps: [1, 2, 4, 8, 16, 32, 64, 128, 256],
            beltMotor: [1, 12, 16, 20, 24, 30, 32, 36, 40, 48, 60],
            beltWorm: [1, 12, 16, 20, 24, 30, 32, 36, 40, 48, 60],
            wormTeeth: [1, 96, 130, 135, 144, 150, 180, 256, 360, 435]
        };

        const presetRatios = {
            '12288': '12288 (EQ5/HEQ5, 32μs, Belt Mod 3:1)',
            '3840': '3840 (EQ5/HEQ5, 16μs, Direct Drive)',
            '15360': '15360 (EQ6/NEQ6, 32μs, Belt Mod 3:1)',
        };
        
        const schemas = {
            onstepx: [
                { // Step 1: Alapbeállítások
                    PINMAP: { type: 'select', labelKey: 'PINMAP_LABEL', descriptionKey: 'PINMAP_DESC', options: ['FYSETC_E4', 'MiniPCB', 'MiniPCB2', 'MaxPCB2', 'MaxESP3', 'CNC3', 'STM32Blue', 'MaxSTM3', 'FYSETC_S6_2'], defaultValue: 'FYSETC_E4' },
                    MOUNT_TYPE: { type: 'select', labelKey: 'MOUNT_TYPE_LABEL', descriptionKey: 'MOUNT_TYPE_DESC', options: ['GEM', 'GEM_TA', 'GEM_TAC', 'FORK', 'FORK_TA', 'FORK_TAC', 'ALTAZM', 'ALTAZM_UNL'], defaultValue: 'GEM' }
                },
                { // Step 2: Motor és Áttétel
                    AXIS1_STEPS_PER_DEGREE: { type: 'calculator', labelKey: 'AXIS1_SPD_LABEL', descriptionKey: 'AXIS_SPD_DESC', defaultValue: 12288.0 },
                    AXIS2_STEPS_PER_DEGREE: { type: 'calculator', labelKey: 'AXIS2_SPD_LABEL', descriptionKey: 'AXIS_SPD_DESC', defaultValue: 12288.0 },
                },
                { // Step 3: Meghajtó Beállítások
                    AXIS1_DRIVER_MODEL: { type: 'select', labelKey: 'AXIS_DM_LABEL', descriptionKey: 'AXIS_DM_DESC', options: ['A4988', 'DRV8825', 'TMC2130', 'TMC2209', 'TMC5160'], defaultValue: 'TMC2209' },
                    AXIS1_DRIVER_MICROSTEPS: { type: 'select', labelKey: 'AXIS_MS_LABEL', descriptionKey: 'AXIS_MS_DESC', options: [8, 16, 32, 64, 128], defaultValue: 32 },
                    AXIS1_DRIVER_MICROSTEPS_GOTO: { type: 'select', labelKey: 'AXIS_MSG_LABEL', descriptionKey: 'AXIS_MSG_DESC', options: [1, 2, 4, 8, 16], defaultValue: 4 },
                    AXIS1_REVERSE: { type: 'select', labelKey: 'AXIS_REV_LABEL', descriptionKey: 'AXIS_REV_DESC', options: ['OFF', 'ON'], defaultValue: 'OFF' },
                    AXIS2_DRIVER_MODEL: { type: 'select', labelKey: 'AXIS_DM_LABEL', descriptionKey: 'AXIS_DM_DESC', options: ['A4988', 'DRV8825', 'TMC2130', 'TMC2209', 'TMC5160'], defaultValue: 'TMC2209' },
                    AXIS2_DRIVER_MICROSTEPS: { type: 'select', labelKey: 'AXIS_MS_LABEL', descriptionKey: 'AXIS_MS_DESC', options: [8, 16, 32, 64, 128], defaultValue: 32 },
                    AXIS2_DRIVER_MICROSTEPS_GOTO: { type: 'select', labelKey: 'AXIS_MSG_LABEL', descriptionKey: 'AXIS_MSG_DESC', options: [1, 2, 4, 8, 16], defaultValue: 4 },
                    AXIS2_REVERSE: { type: 'select', labelKey: 'AXIS_REV_LABEL', descriptionKey: 'AXIS_REV_DESC', options: ['OFF', 'ON'], defaultValue: 'OFF' },
                },
                { // Step 4: Összegzés és Generálás
                    _summary: true
                } 
            ],
            classic: [
                { // Step 1
                    PINMAP: { type: 'select', labelKey: 'PINMAP_LABEL', descriptionKey: 'PINMAP_DESC', options: ['MksGenL2', 'MiniPCB2', 'MaxPCB2', 'MaxESP3', 'CNC3', 'STM32Blue', 'MaxSTM3', 'FYSETC_S6_2'], defaultValue: 'OFF' },
                    MOUNT_TYPE: { type: 'select', labelKey: 'MOUNT_TYPE_LABEL', descriptionKey: 'MOUNT_TYPE_DESC', options: ['GEM', 'FORK', 'ALTAZM'], defaultValue: 'GEM' }
                },
                { // Step 2
                    AXIS1_STEPS_PER_DEGREE: { type: 'calculator', labelKey: 'AXIS1_SPD_LABEL', descriptionKey: 'AXIS_SPD_DESC', defaultValue: 3840.0 },
                    AXIS2_STEPS_PER_DEGREE: { type: 'calculator', labelKey: 'AXIS2_SPD_LABEL', descriptionKey: 'AXIS_SPD_DESC', defaultValue: 3840.0 },
                },
                { // Step 3
                    AXIS1_DRIVER_MODEL: { type: 'select', labelKey: 'AXIS_DM_LABEL', descriptionKey: 'AXIS_DM_DESC', options: ['A4988', 'DRV8825', 'LV8729', 'TMC2209'], defaultValue: 'A4988' },
                    AXIS1_DRIVER_MICROSTEPS: { type: 'select', labelKey: 'AXIS_MS_LABEL', descriptionKey: 'AXIS_MS_DESC', options: [8, 16, 32], defaultValue: 16 },
                    AXIS1_DRIVER_MICROSTEPS_GOTO: { type: 'select', labelKey: 'AXIS_MSG_LABEL', descriptionKey: 'AXIS_MSG_DESC', options: [1, 2, 4, 8], defaultValue: 4 },
                    AXIS1_DRIVER_REVERSE: { type: 'select', labelKey: 'AXIS_REV_LABEL', descriptionKey: 'AXIS_REV_DESC', options: ['OFF', 'ON'], defaultValue: 'OFF' },
                    AXIS2_DRIVER_MODEL: { type: 'select', labelKey: 'AXIS_DM_LABEL', descriptionKey: 'AXIS_DM_DESC', options: ['A4988', 'DRV8825', 'LV8729', 'TMC2209'], defaultValue: 'A4988' },
                    AXIS2_DRIVER_MICROSTEPS: { type: 'select', labelKey: 'AXIS_MS_LABEL', descriptionKey: 'AXIS_MS_DESC', options: [8, 16, 32], defaultValue: 16 },
                    AXIS2_DRIVER_MICROSTEPS_GOTO: { type: 'select', labelKey: 'AXIS_MSG_LABEL', descriptionKey: 'AXIS_MSG_DESC', options: [1, 2, 4, 8], defaultValue: 4 },
                    AXIS2_DRIVER_REVERSE: { type: 'select', labelKey: 'AXIS_REV_LABEL', descriptionKey: 'AXIS_REV_DESC', options: ['OFF', 'ON'], defaultValue: 'OFF' },
                },
                { // Step 4
                    _summary: true
                }
            ]
        };

        // ===================================================================================
        // APPLICATION STATE
        // ===================================================================================
        const appState = { version: null, language: 'en', config: {}, i18n: {}, wizardStep: 0 };
        let stars = [];

        // ===================================================================================
        // DOM ELEMENTS
        // ===================================================================================
        const dom = {
            main: document.querySelector('main'),
            versionSelector: document.getElementById('version-selector'),
            configWizard: document.getElementById('config-wizard'),
            appFooter: document.getElementById('app-footer'),
            constellationCanvas: document.getElementById('constellation-canvas'),
            wikiButton: document.getElementById('wiki-button'),
            wikiSection: document.getElementById('wiki-section'),
            wikiNav: document.getElementById('wiki-nav'),
            wikiArticle: document.getElementById('wiki-article'),
            wikiBackButton: document.getElementById('wiki-back-button'),
            languageSelector: document.getElementById('language-selector'),
            
            infoModal: document.getElementById('info-modal'),
            infoModalTitle: document.getElementById('modal-title'),
            infoModalText: document.getElementById('modal-text'),
            
            beltCalcModal: document.getElementById('belt-calc-modal'),
            beltResultText: document.getElementById('belt-result-text'),
        };
        
        // ===================================================================================
        // UI RENDERING
        // ===================================================================================
        function applyLocalization() {
            const lang = appState.language;
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => { 
                const key = el.dataset.langKey; 
                if (appState.i18n[key]) el.innerHTML = appState.i18n[key]; 
            });
            // Re-render wizard if visible to update labels
            if (!dom.configWizard.classList.contains('hidden')) renderWizard();
            if (!dom.wikiSection.classList.contains('hidden')) {
                const activeLink = dom.wikiNav.querySelector('a.active');
                if (activeLink) renderWikiPage(activeLink.hash.substring(1));
            }
        }

        function renderWizard() {
            dom.configWizard.innerHTML = '';
            const schema = schemas[appState.version];
            if (!schema) return;

            const maxSteps = schema.length;
            const currentStepSchema = schema[appState.wizardStep];
            
            const wizardHeader = document.createElement('div');
            wizardHeader.className = 'wizard-header';
            const backButton = document.createElement('button');
            backButton.className = 'back-button';
            backButton.textContent = appState.i18n.backToHomeButton;
            backButton.onclick = handleBackToHome;
            const wizardTitle = document.createElement('h2');
            const titleKey = `wizardTitleStep${appState.wizardStep + 1}`;
            wizardTitle.textContent = `${appState.i18n[titleKey] || 'Step'} (${appState.wizardStep + 1}/${maxSteps})`;
            wizardHeader.append(backButton, wizardTitle);
            
            const stepContainer = document.createElement('div');
            stepContainer.className = 'step-container';
            
            if (currentStepSchema._summary) {
                stepContainer.style.display = 'flex';
                stepContainer.style.flexDirection = 'column';
                const summaryText = document.createElement('p');
                summaryText.innerHTML = appState.i18n.summaryText;
                stepContainer.appendChild(summaryText);
                
                const previewArea = document.createElement('textarea');
                previewArea.id = 'config-preview';
                previewArea.readOnly = true;
                previewArea.textContent = appState.i18n.summaryWaiting;
                stepContainer.appendChild(previewArea);
                
                generateConfigFile();
            } else {
                const formContent = buildFormForStep(currentStepSchema);
                stepContainer.appendChild(formContent);
            }
            
            const nav = document.createElement('div');
            nav.className = 'wizard-nav';
            const prevButton = document.createElement('button');
            prevButton.textContent = appState.i18n.wizardPrev;
            prevButton.className = 'button';
            prevButton.disabled = appState.wizardStep === 0;
            prevButton.onclick = () => changeWizardStep(-1);
            
            const nextButtonContainer = document.createElement('div');
            if (appState.wizardStep < maxSteps - 2) {
                const nextButton = document.createElement('button');
                nextButton.textContent = appState.i18n.wizardNext;
                nextButton.className = 'button primary';
                nextButton.onclick = () => changeWizardStep(1);
                nextButtonContainer.appendChild(nextButton);
            } else if (appState.wizardStep === maxSteps - 2) {
                const summaryButton = document.createElement('button');
                summaryButton.textContent = appState.i18n.wizardSummary;
                summaryButton.className = 'button primary';
                summaryButton.onclick = () => changeWizardStep(1);
                nextButtonContainer.appendChild(summaryButton);
            } else {
                 const downloadButton = document.createElement('button');
                 downloadButton.id = 'download-btn';
                 downloadButton.textContent = appState.i18n.downloadButton;
                 downloadButton.className = 'button primary';
                 downloadButton.disabled = true;
                 downloadButton.onclick = downloadConfigFile;
                 nextButtonContainer.appendChild(downloadButton);
            }
            
            nav.append(prevButton, nextButtonContainer);
            dom.configWizard.append(wizardHeader, stepContainer, nav);
            bindWizardEvents();
        }
        
        function buildFormForStep(stepSchema) {
            const fragment = document.createDocumentFragment();
            if (stepSchema.AXIS1_DRIVER_MODEL) {
                const axis1Section = document.createElement('div');
                axis1Section.className = 'axis-section';
                const h3_1 = document.createElement('h3');
                h3_1.textContent = 'RA/AZM Axis';
                axis1Section.appendChild(h3_1);
                
                const axis2Section = document.createElement('div');
                axis2Section.className = 'axis-section';
                const h3_2 = document.createElement('h3');
                h3_2.textContent = 'DEC/ALT Axis';
                axis2Section.appendChild(h3_2);
                
                for (const key in stepSchema) {
                    const def = stepSchema[key];
                    const formControl = createFormControl(key, def);
                    if(key.startsWith('AXIS1')) axis1Section.appendChild(formControl);
                    else if (key.startsWith('AXIS2')) axis2Section.appendChild(formControl);
                }
                fragment.append(axis1Section, axis2Section);
            } else {
                 for (const key in stepSchema) {
                    const def = stepSchema[key];
                    fragment.appendChild(createFormControl(key, def));
                }
            }
            return fragment;
        }

        function createFormControl(key, def) {
            if (appState.config[key] === undefined) appState.config[key] = def.defaultValue;
            
            const group = document.createElement('div');
            group.className = 'form-group';
            const label = document.createElement('label');
            label.htmlFor = key;
            label.textContent = appState.i18n[def.labelKey] || key;
            const infoIcon = document.createElement('span');
            infoIcon.className = 'info-icon';
            infoIcon.textContent = '?';
            infoIcon.dataset.key = key;
            label.appendChild(infoIcon);
            group.appendChild(label);

            if (def.type === 'select') {
                const select = document.createElement('select');
                select.id = key; select.name = key;
                def.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt; option.textContent = opt;
                    if (opt == appState.config[key]) option.selected = true;
                    select.appendChild(option);
                });
                group.appendChild(select);
            } else if (def.type === 'calculator') {
                const output = document.createElement('input');
                output.type = 'text'; output.id = key; output.name = key;
                output.value = appState.config[key]; output.readOnly = true;
                group.appendChild(output);
                group.appendChild(createCalculatorDOM(key));
            }
            return group;
        }

        function createCalculatorDOM(axisKey) {
            const container = document.createElement('div');
            
            // Radio buttons for mode selection
            const radioGroup = document.createElement('div');
            radioGroup.className = 'radio-group';
            radioGroup.innerHTML = `
                <label><input type="radio" name="calc_mode_${axisKey}" value="preset" checked> ${appState.i18n.beltCalcPreset}</label>
                <label><input type="radio" name="calc_mode_${axisKey}" value="custom"> ${appState.i18n.beltCalcCustom}</label>
            `;
            container.appendChild(radioGroup);

            // Preset dropdown
            const presetGroup = document.createElement('div');
            presetGroup.id = `preset_group_${axisKey}`;
            const presetSelect = document.createElement('select');
            presetSelect.dataset.field = 'preset';
            for (const val in presetRatios) {
                const option = document.createElement('option');
                option.value = val;
                option.textContent = presetRatios[val];
                if (val == appState.config[axisKey]) option.selected = true;
                presetSelect.appendChild(option);
            }
            presetGroup.appendChild(presetSelect);
            container.appendChild(presetGroup);

            // Custom calculation grid
            const grid = document.createElement('div');
            grid.className = 'calculator-grid hidden';
            grid.id = `custom_group_${axisKey}`;
            grid.dataset.axis = axisKey;
            
            const fields = { 
                motorSteps: { labelKey: 'CALC_MOTOR_STEPS_LABEL', descKey: 'CALC_MOTOR_STEPS_DESC', defaultValue: 200 },
                beltMotor: { labelKey: 'CALC_BELT_MOTOR_LABEL', descKey: 'CALC_BELT_MOTOR_DESC', defaultValue: 16 },
                beltWorm: { labelKey: 'CALC_BELT_WORM_LABEL', descKey: 'CALC_BELT_WORM_DESC', defaultValue: 48 },
                wormTeeth: { labelKey: 'CALC_WORM_TEETH_LABEL', descKey: 'CALC_WORM_TEETH_DESC', defaultValue: 144 }
            };

            for (const fieldKey in fields) {
                const field = fields[fieldKey];
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = appState.i18n[field.labelKey];
                label.dataset.infoKey = fieldKey;
                
                const select = document.createElement('select');
                select.dataset.field = fieldKey;
                
                calculatorOptions[fieldKey].forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt; option.textContent = opt;
                    if (opt === field.defaultValue) option.selected = true;
                    select.appendChild(option);
                });
                
                formGroup.append(label, select);
                grid.appendChild(formGroup);
            }

            const microstepGroup = document.createElement('div');
            microstepGroup.className = 'form-group';
            const microstepLabel = document.createElement('label');
            microstepLabel.textContent = appState.i18n.CALC_MICROSTEPS_LABEL;
            microstepLabel.dataset.infoKey = 'microsteps';
            const microstepDisplay = document.createElement('div');
            microstepDisplay.className = 'microstep-display';
            microstepDisplay.dataset.field = "microsteps_display";
            const axisNum = axisKey.includes('1') ? 1 : 2;
            const microstepValue = appState.config[`AXIS${axisNum}_DRIVER_MICROSTEPS`] || schemas[appState.version][2][`AXIS${axisNum}_DRIVER_MICROSTEPS`].defaultValue;
            microstepDisplay.textContent = `${microstepValue} (${appState.i18n.microstepSetInStep3})`;
            microstepGroup.append(microstepLabel, microstepDisplay);
            grid.appendChild(microstepGroup);

            container.appendChild(grid);
            
            const beltCalcButton = document.createElement('button');
            beltCalcButton.type = 'button';
            beltCalcButton.className = 'button';
            beltCalcButton.textContent = appState.i18n.beltCalcButton;
            beltCalcButton.style.marginTop = '1rem';
            beltCalcButton.onclick = () => showBeltCalcModal();
            container.appendChild(beltCalcButton);

            return container;
        }
        
        function renderWikiPage(pageKey) {
            dom.wikiNav.querySelectorAll('a').forEach(a => a.classList.remove('active'));
            const activeLink = dom.wikiNav.querySelector(`a[href="#${pageKey}"]`);
            if (activeLink) activeLink.classList.add('active');
            
            dom.wikiArticle.innerHTML = `<h2>${appState.i18n[`wiki_page_${pageKey}_title`]}</h2>${appState.i18n[`wiki_page_${pageKey}_content`]}`;
        }

        // ===================================================================================
        // EVENT HANDLERS & ACTIONS
        // ===================================================================================
        async function loadLanguage(lang) {
            appState.language = lang;
            localStorage.setItem('onstep_language', lang);
            dom.languageSelector.value = lang;

            try {
                const response = await fetch(`locales/${lang}.json?v=${APP_VERSION}`);
                if (!response.ok) throw new Error(`Language file for ${lang} not found.`);
                appState.i18n = await response.json();
            } catch (error) {
                console.error(error.message, "Falling back to English.");
                try {
                    const response = await fetch(`locales/en.json?v=${APP_VERSION}`);
                    appState.i18n = await response.json();
                    appState.language = 'en';
                    dom.languageSelector.value = 'en';
                } catch (fallbackError) {
                    console.error("Fallback to English failed. Using empty translations.");
                    appState.i18n = {};
                }
            } finally {
                applyLocalization();
            }
        }
        
        function handleVersionSelect(selectedVersion) {
            appState.version = selectedVersion;
            appState.wizardStep = 0;
            appState.config = {}; // Reset config
            dom.versionSelector.classList.add('hidden');
            dom.configWizard.classList.remove('hidden');
            renderWizard();
        }

        function handleBackToHome() {
            appState.version = null; appState.config = {};
            dom.configWizard.classList.add('hidden');
            dom.wikiSection.classList.add('hidden');
            dom.versionSelector.classList.remove('hidden');
            dom.configWizard.innerHTML = '';
        }
        
        function showWiki() {
            dom.versionSelector.classList.add('hidden');
            dom.wikiSection.classList.remove('hidden');
            const firstLink = dom.wikiNav.querySelector('a');
            if(firstLink) renderWikiPage(firstLink.hash.substring(1));
        }

        function changeWizardStep(direction) {
            appState.wizardStep += direction;
            renderWizard();
        }

        function updateSPD(axisKey) {
            const axisNum = axisKey.includes('1') ? 1 : 2;
            const container = document.getElementById(axisKey).parentElement;
            const mode = container.querySelector(`input[name="calc_mode_${axisKey}"]:checked`).value;
            let spd = 0;

            if (mode === 'preset') {
                const presetSelect = container.querySelector(`#preset_group_${axisKey} select`);
                spd = parseFloat(presetSelect.value);
            } else {
                const grid = container.querySelector(`#custom_group_${axisKey}`);
                if (!grid) return;
                const motorSteps = parseFloat(grid.querySelector('[data-field="motorSteps"]').value) || 0;
                const microsteps = appState.config[`AXIS${axisNum}_DRIVER_MICROSTEPS`] || schemas[appState.version][2][`AXIS${axisNum}_DRIVER_MICROSTEPS`].defaultValue;
                const beltMotor = parseFloat(grid.querySelector('[data-field="beltMotor"]').value) || 1;
                const beltWorm = parseFloat(grid.querySelector('[data-field="beltWorm"]').value) || 1;
                const wormTeeth = parseFloat(grid.querySelector('[data-field="wormTeeth"]').value) || 0;

                const beltRatio = beltMotor > 0 ? beltWorm / beltMotor : 0;
                const totalRatio = beltRatio * wormTeeth;
                spd = (motorSteps * microsteps * totalRatio) / 360;
            }

            const output = document.getElementById(axisKey);
            if (output) output.value = isFinite(spd) ? spd.toFixed(4) : '0.0000';
            appState.config[axisKey] = output.value;
        }

        async function generateConfigFile() {
            const previewArea = document.getElementById('config-preview');
            const downloadBtn = document.getElementById('download-btn');
            if (!previewArea || !downloadBtn) return;
            downloadBtn.disabled = true;

            try {
                const templateName = appState.version === 'classic' ? 'template-onstep.txt' : 'template-onstepx.txt';
                const response = await fetch(`${templateName}?v=${APP_VERSION}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                let content = await response.text();

                // Initialize config with all defaults first
                schemas[appState.version].forEach(step => {
                    for(const key in step) {
                        if (key !== '_summary' && appState.config[key] === undefined) {
                            appState.config[key] = step[key].defaultValue;
                        }
                    }
                });
                
                for (const key in appState.config) {
                    const value = appState.config[key];
                    const regex = new RegExp(`(#define\\s+${key}\\s+)(.*?)(\\s*\\/\\/|$)`);
                    if (content.match(regex)) {
                         content = content.replace(regex, `$1${value}$3`);
                    }
                }
                previewArea.value = content;
                downloadBtn.disabled = false;
            } catch (error) {
                console.error("Error generating config file:", error);
                previewArea.textContent = "Error during generation. Please try again.";
            }
        }
        
        function downloadConfigFile() {
            const content = document.getElementById('config-preview').value;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Config.h';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showInfoModal(key, isCalc = false) {
            let def;
            if (isCalc) {
                const fields = { 
                    motorSteps: { labelKey: 'CALC_MOTOR_STEPS_LABEL', descriptionKey: 'CALC_MOTOR_STEPS_DESC' },
                    microsteps: { labelKey: 'CALC_MICROSTEPS_LABEL', descriptionKey: 'CALC_MICROSTEPS_DESC' },
                    beltMotor: { labelKey: 'CALC_BELT_MOTOR_LABEL', descriptionKey: 'CALC_BELT_MOTOR_DESC' },
                    beltWorm: { labelKey: 'CALC_BELT_WORM_LABEL', descriptionKey: 'CALC_BELT_WORM_DESC' },
                    wormTeeth: { labelKey: 'CALC_WORM_TEETH_LABEL', descriptionKey: 'CALC_WORM_TEETH_DESC' }
                };
                def = fields[key];
            } else {
                 const stepSchema = schemas[appState.version]?.[appState.wizardStep];
                 def = stepSchema?.[key];
            }
           
            if (def) {
                dom.infoModalTitle.innerHTML = appState.i18n[def.labelKey] || key;
                dom.infoModalText.innerHTML = (appState.i18n[def.descriptionKey] || 'N/A');
                dom.infoModal.classList.add('visible');
            }
        }
        function hideInfoModal(modal) { modal.classList.remove('visible'); }
        
        function showBeltCalcModal() { dom.beltCalcModal.classList.add('visible'); calculateBeltLength(); }
        function calculateBeltLength() {
            const p1 = parseFloat(document.getElementById('belt-p1').value);
            const p2 = parseFloat(document.getElementById('belt-p2').value);
            const pitch = parseFloat(document.getElementById('belt-pitch').value);
            const dist = parseFloat(document.getElementById('belt-distance').value);
            if ([p1, p2, pitch, dist].some(isNaN)) return;

            const r1 = (p1 * pitch) / (2 * Math.PI);
            const r2 = (p2 * pitch) / (2 * Math.PI);
            const length = Math.sqrt(4 * dist**2 - (r1 - r2)**2) + Math.PI * (r1 + r2) + Math.asin((r1 - r2) / (2*dist)) * (r1 - r2);
            const teeth = Math.round(length / pitch);
            dom.beltResultText.innerHTML = `${appState.i18n.beltCalcLength}: <strong>${length.toFixed(2)} mm</strong><br>${appState.i18n.beltCalcTeeth}: <strong>${teeth}</strong>`;
        }

        // ===================================================================================
        // BACKGROUND ANIMATION
        // ===================================================================================
        function initBackground() {
            const canvas = dom.constellationCanvas;
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            stars = [];
            for (let i = 0; i < 250; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    r: Math.random() * 1.5 + 0.5,
                    vx: (Math.random() - 0.5) * 0.1,
                    vy: (Math.random() - 0.5) * 0.1,
                });
            }
        }

        function animateBackground() {
            const canvas = dom.constellationCanvas;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            stars.forEach(star => {
                star.x += star.vx; star.y += star.vy;
                if (star.x < 0 || star.x > canvas.width) star.vx *= -1;
                if (star.y < 0 || star.y > canvas.height) star.vy *= -1;
                ctx.fillStyle = 'rgba(224, 229, 240, 0.7)';
                ctx.beginPath(); ctx.arc(star.x, star.y, star.r, 0, Math.PI * 2); ctx.fill();
            });
            requestAnimationFrame(animateBackground);
        }
        
        // ===================================================================================
        // EVENT BINDING
        // ===================================================================================
        function bindEventListeners() {
            document.querySelectorAll('.version-card').forEach(card => card.addEventListener('click', () => handleVersionSelect(card.dataset.version)));
            
            [dom.infoModal, dom.beltCalcModal].forEach(modal => {
                modal.querySelector('.modal-close').addEventListener('click', () => hideInfoModal(modal));
                modal.addEventListener('click', e => { if (e.target === modal) hideInfoModal(modal); });
            });
            
            window.addEventListener('keydown', e => { if (e.key === 'Escape') { hideInfoModal(dom.infoModal); hideInfoModal(dom.beltCalcModal); }});
            dom.wikiButton.addEventListener('click', showWiki);
            dom.wikiBackButton.addEventListener('click', handleBackToHome);
            dom.wikiNav.addEventListener('click', e => { e.preventDefault(); if (e.target.tagName === 'A') renderWikiPage(e.target.hash.substring(1)); });
            dom.languageSelector.addEventListener('change', (e) => loadLanguage(e.target.value));

            dom.beltCalcModal.addEventListener('input', calculateBeltLength);
        }
        
        function bindWizardEvents() {
            dom.configWizard.addEventListener('click', e => {
                 if (e.target.classList.contains('info-icon')) showInfoModal(e.target.dataset.key);
                 else if (e.target.matches('.calculator-grid label[data-info-key]')) showInfoModal(e.target.dataset.infoKey, true);
            });

            dom.configWizard.addEventListener('change', e => {
                const target = e.target;
                if (target.tagName === 'SELECT') {
                    if (target.id) appState.config[target.id] = target.value;
                    
                    const calculator = target.closest('.form-group');
                    const axisKey = calculator?.querySelector('input[readonly]')?.id;
                    if (axisKey) updateSPD(axisKey);

                } else if (target.type === 'radio' && target.name.startsWith('calc_mode_')) {
                    const axisKey = target.name.replace('calc_mode_', '');
                    const presetGroup = document.getElementById(`preset_group_${axisKey}`);
                    const customGroup = document.getElementById(`custom_group_${axisKey}`);
                    if (target.value === 'preset') {
                        presetGroup.classList.remove('hidden');
                        customGroup.classList.add('hidden');
                    } else {
                        presetGroup.classList.add('hidden');
                        customGroup.classList.remove('hidden');
                    }
                    updateSPD(axisKey);
                }
            });
             document.querySelectorAll('[id^=AXIS][id$=_STEPS_PER_DEGREE]').forEach(input => updateSPD(input.id));
        }

        // ===================================================================================
        // INITIALIZATION
        // ===================================================================================
        function initFooter() {
            const year = new Date().getFullYear();
            dom.appFooter.innerHTML = `&copy; ${year} OnStep Configurator v${APP_VERSION}`;
        }

        async function init() {
            const savedLang = localStorage.getItem('onstep_language');
            const browserLang = navigator.language.split('-')[0];
            
            let initialLang = 'en'; // Default to English
            if (savedLang && ['en', 'de', 'es', 'hu'].includes(savedLang)) {
                initialLang = savedLang;
            } else if (['en', 'de', 'es', 'hu'].includes(browserLang)) {
                initialLang = browserLang;
            }
            
            await loadLanguage(initialLang);
            bindEventListeners();
            initFooter();
            initBackground();
            animateBackground();
            window.addEventListener('resize', initBackground);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
